<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Grouping Typesets With MathJax</title>
  <link rel="alternate" href="https://feeds.feedburner.com/janmr-blog" title="janmr blog" type="application/rss+xml">
  <link rel="stylesheet" href="/css/main.7614535f90467929.css">
</head>
<body>
  <div id="wrapper">
    <h1><a href="/blog/">janmr blog</a></h1>
    <div class="content">
      <div class="main">        <h2>Grouping Typesets With MathJax<br><small><time datetime="2015-03-03">03 March 2015</time></small></h2>
        <div class="post-tags">
          <a class="label" href="/blog/tags/mathjax">mathjax</a> 
        </div>
        <div class="post-body">
          <p>When <a href="http://mathjax.org">MathJax</a> typesets the equations on a web page, it does a good job of grouping the work into chunks, so that a chunk of equations (see the <a href="http://docs.mathjax.org/en/v2.5-latest/options/HTML-CSS.html">EqnChunk option</a> will be typeset before they are displayed and the next chunk is processed. Typesetting and displaying only one equation at a time would lead to a lot of screen flickering and it would also take longer before the page has been completed because of the increased work for the browser.</p>
<p>Sometimes you want to typeset and display a lot of equations <a href="http://docs.mathjax.org/en/v2.5-latest/typeset.html">dynamically</a>. For the sake of this post, let us assume that we have an array <code>scripts</code> where each entry refers to an HTML script element containing some TeX to typeset. (Using script elements and <a href="http://docs.mathjax.org/en/v2.5-latest/api/hub.html#Process"><code>MathJax.Hub.Process</code></a> avoids the need for running any preprocessors, but the following is equally valid when using <code>MathJax.Hub.Typeset</code> and preprocessors.)</p>
<p>In this case it is easy to trigger the typesetting as</p>
<pre><code class="language-javascript hljs">MathJax.Hub.Queue([&quot;Process&quot;, MathJax.Hub, scripts]);
</code></pre>
<p>This is an efficient way to do it and MathJax will take care of all the equation chunking (<a href="http://jsfiddle.net/janmr/g870rjLp/1/">demo</a>). If fact, it is <em>the best</em> way and should be used whenever possible. But sometimes the equations are not available in one big array and you wish to tell MathJax to process the equations as they become available. This use-case can be simulated by running</p>
<pre><code class="language-javascript hljs"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; scripts.length; k++)
  MathJax.Hub.Queue([&quot;Process&quot;, MathJax.Hub, scripts[k]]);
</code></pre>
<p>Submitting typesetting requests this way will lead to <em>no chunking</em>. Each equation will be typeset and put into the DOM one by one. Prior to version 2.5, control would not be returned to the browser's drawing layer before the whole queue had been emptied. This would make all equations appear at once when the queue was empty, but each equation insertion would <em>still require a page reflow</em>. With version 2.5, however, a short delay was inserted during the processing of each equation, leading to displaying the equations as they are inserted into the DOM (<a href="http://jsfiddle.net/janmr/c5tcvzyL/">demo</a>). Note that this short delay can be removed by using <code>MathJax.Hub.processSectionDelay=0</code>, see the configuration in the previous demo. (Thanks to Davide Cervone, MathJax's main developer, for <a href="https://groups.google.com/d/msg/mathjax-dev/1QsO1B6OZ40/MLOAeaPzNFkJ">clarifying these things</a> for me.)</p>
<p>Delay or not, queueing equations one by one leads to suboptimal performance. On my machine and browser, queueing the equations one by one (with the default <code>processSectionDelay</code>) takes about 20 seconds (!). Removing the delay reduces typesetting time to around 7 seconds, a huge improvement. The optimal, however, where all equations are submitted in one go, takes about 3 seconds.</p>
<p>So how can we submit equations for typesetting one by one, while still getting good performance? A near-optimal approach is to maintain a queue of yet-to-be-typeset equations and using the callback of <code>Process</code> to be notified of when a typesetting job is done:</p>
<pre><code class="language-javascript hljs"><span class="hljs-keyword">var</span> queue = [], typesetting = <span class="hljs-literal">false</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">done</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (queue.length) start();
    <span class="hljs-keyword">else</span> typesetting = <span class="hljs-literal">false</span>;
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">start</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> q = queue;
    queue = [];
    MathJax.Hub.Queue([<span class="hljs-string">'Process'</span>, MathJax.Hub, q, done]);
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">typeset</span>(<span class="hljs-params">script</span>) </span>{
    queue.push(script);
    <span class="hljs-keyword">if</span> (!typesetting) {
        typesetting = <span class="hljs-literal">true</span>;
        start();
    }
}
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; scripts.length; k++)
    typeset(scripts[k]);
</code></pre>
<p>In this example, MathJax will go to work typesetting the first entry in the <code>scripts</code> array. While this is happening, the rest of the array will be pushed onto the <code>queue</code> variable. Now, when typesetting of the first equation is done, the remaining equations will be handled collectively (<a href="http://jsfiddle.net/janmr/6vk0v0cq/2/">demo</a>). This leads to the example running in time comparable to submitting the whole array directly.</p>

        </div>
        <div class="page-navigation">
          <div class="prev-post">
            <a href="/blog/2015/01/typesetting-math-with-html-and-css-fractions" title="Previous post: Typesetting Math Using HTML and CSS &amp;mdash; Fractions">&laquo; Typesetting Math Using HTML and CSS &mdash; Fractions</a>
          </div>
          <div class="next-post">
            <a href="/blog/2015/03/mathjax-2.4-vs-2.5" title="Next post: MathJax 2.4 vs 2.5">MathJax 2.4 vs 2.5 &raquo;</a>
          </div>
        </div>
        <div id="disqus_thread"></div>
      </div>
      <div class="sidebar">
        <h4>About</h4>
        <p>A blog about mathematics and computer programming by
          <a href="/">Jan Marthedal Rasmussen</a>.</p>
        <h4>Links</h4>
        <p><span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
            <circle cx="2" cy="4" r="2"></circle><circle cx="2" cy="12" r="2"></circle><circle cx="2" cy="20" r="2"></circle><circle cx="2" cy="28" r="2"></circle>
            <rect x="8" y="2" width="24" height="4"></rect><rect x="8" y="10" width="24" height="4"></rect><rect x="8" y="18" width="24" height="4"></rect><rect x="8" y="26" width="24" height="4"></rect>
          </svg>
        </span>
        <a href="/blog/">All posts</a></p>
        <p><span class="icon">
          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414">
            <path d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.37-1.337.64-2.085.79-.598-.64-1.45-1.04-2.396-1.04-1.812 0-3.282 1.47-3.282 3.28 0 .26.03.51.085.75-2.728-.13-5.147-1.44-6.766-3.42C.83 2.58.67 3.14.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21 0-.41-.02-.61-.058.42 1.304 1.63 2.253 3.07 2.28-1.12.88-2.54 1.404-4.07 1.404-.26 0-.52-.015-.78-.045 1.46.93 3.18 1.474 5.04 1.474 6.04 0 9.34-5 9.34-9.33 0-.14 0-.28-.01-.42.64-.46 1.2-1.04 1.64-1.7z" fill-rule="nonzero"/>
          </svg></span>
          <a href="https://twitter.com/janmarthedal">Twitter profile</a></p>
        <p><span class="icon">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414">
            <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
          </svg></span>
          <a href="https://github.com/janmarthedal/">GitHub profile</a></p>
        <p><span class="icon">
          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414">
            <path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194 11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0 13.806c0-1.21.983-2.195 2.194-2.195zM10.606 16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"/>
          </svg></span>
          <a href="https://feeds.feedburner.com/janmr-blog">Subscribe in a reader</a></p>
        <footer><p class="text-muted">Copyright Jan Marthedal Rasmussen © 2019</p></footer>
      </div>
    </div>
  </div>
  <script src="/js/main.9d716cf03cf8bdc8.js" defer></script>
  <script src="https://www.google-analytics.com/analytics.js" defer></script>
</body>
</html>
