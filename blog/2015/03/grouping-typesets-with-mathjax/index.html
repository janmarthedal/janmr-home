<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Grouping Typesets With MathJax</title>
  <link rel="alternate" href="http://feeds.feedburner.com/janmr-blog" title="janmr blog" type="application/rss+xml">
  <link rel="stylesheet" href="/css/main.9a888a8bccb3dfde.css">
</head>
<body>
  <div id="wrapper">
    <h1><a href="/blog/">janmr blog</a></h1>
    <div class="content">
      <div class="main">        <h2>Grouping Typesets With MathJax<br><small><time datetime="2015-03-03">03 March 2015</time></small></h2>
        <div class="post-tags">
          <a class="label" href="/blog/tags/mathjax">mathjax</a> 
        </div>
        <div class="post-body">
          <p>When <a href="http://mathjax.org">MathJax</a> typesets the equations on a web page, it does a good job of grouping the work into chunks, so that a chunk of equations (see the <a href="http://docs.mathjax.org/en/v2.5-latest/options/HTML-CSS.html">EqnChunk option</a> will be typeset before they are displayed and the next chunk is processed. Typesetting and displaying only one equation at a time would lead to a lot of screen flickering and it would also take longer before the page has been completed because of the increased work for the browser.</p>
<p>Sometimes you want to typeset and display a lot of equations <a href="http://docs.mathjax.org/en/v2.5-latest/typeset.html">dynamically</a>. For the sake of this post, let us assume that we have an array <code>scripts</code> where each entry refers to an HTML script element containing some TeX to typeset. (Using script elements and <a href="http://docs.mathjax.org/en/v2.5-latest/api/hub.html#Process"><code>MathJax.Hub.Process</code></a> avoids the need for running any preprocessors, but the following is equally valid when using <code>MathJax.Hub.Typeset</code> and preprocessors.)</p>
<p>In this case it is easy to trigger the typesetting as</p>
<pre><code class="language-javascript hljs">MathJax.Hub.Queue([&quot;Process&quot;, MathJax.Hub, scripts]);
</code></pre>
<p>This is an efficient way to do it and MathJax will take care of all the equation chunking (<a href="http://jsfiddle.net/janmr/g870rjLp/1/">demo</a>). If fact, it is <em>the best</em> way and should be used whenever possible. But sometimes the equations are not available in one big array and you wish to tell MathJax to process the equations as they become available. This use-case can be simulated by running</p>
<pre><code class="language-javascript hljs"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; scripts.length; k++)
  MathJax.Hub.Queue([&quot;Process&quot;, MathJax.Hub, scripts[k]]);
</code></pre>
<p>Submitting typesetting requests this way will lead to <em>no chunking</em>. Each equation will be typeset and put into the DOM one by one. Prior to version 2.5, control would not be returned to the browser's drawing layer before the whole queue had been emptied. This would make all equations appear at once when the queue was empty, but each equation insertion would <em>still require a page reflow</em>. With version 2.5, however, a short delay was inserted during the processing of each equation, leading to displaying the equations as they are inserted into the DOM (<a href="http://jsfiddle.net/janmr/c5tcvzyL/">demo</a>). Note that this short delay can be removed by using <code>MathJax.Hub.processSectionDelay=0</code>, see the configuration in the previous demo. (Thanks to Davide Cervone, MathJax's main developer, for <a href="https://groups.google.com/d/msg/mathjax-dev/1QsO1B6OZ40/MLOAeaPzNFkJ">clarifying these things</a> for me.)</p>
<p>Delay or not, queueing equations one by one leads to suboptimal performance. On my machine and browser, queueing the equations one by one (with the default <code>processSectionDelay</code>) takes about 20 seconds (!). Removing the delay reduces typesetting time to around 7 seconds, a huge improvement. The optimal, however, where all equations are submitted in one go, takes about 3 seconds.</p>
<p>So how can we submit equations for typesetting one by one, while still getting good performance? A near-optimal approach is to maintain a queue of yet-to-be-typeset equations and using the callback of <code>Process</code> to be notified of when a typesetting job is done:</p>
<pre><code class="language-javascript hljs"><span class="hljs-keyword">var</span> queue = [], typesetting = <span class="hljs-literal">false</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">done</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (queue.length) start();
    <span class="hljs-keyword">else</span> typesetting = <span class="hljs-literal">false</span>;
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">start</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> q = queue;
    queue = [];
    MathJax.Hub.Queue([<span class="hljs-string">'Process'</span>, MathJax.Hub, q, done]);
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">typeset</span>(<span class="hljs-params">script</span>) </span>{
    queue.push(script);
    <span class="hljs-keyword">if</span> (!typesetting) {
        typesetting = <span class="hljs-literal">true</span>;
        start();
    }
}
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; scripts.length; k++)
    typeset(scripts[k]);
</code></pre>
<p>In this example, MathJax will go to work typesetting the first entry in the <code>scripts</code> array. While this is happening, the rest of the array will be pushed onto the <code>queue</code> variable. Now, when typesetting of the first equation is done, the remaining equations will be handled collectively (<a href="http://jsfiddle.net/janmr/6vk0v0cq/2/">demo</a>). This leads to the example running in time comparable to submitting the whole array directly.</p>

        </div>
        <div class="page-navigation">
          <div class="prev-post">
            <a href="/blog/2015/01/typesetting-math-with-html-and-css-fractions" title="Previous post: Typesetting Math Using HTML and CSS &amp;mdash; Fractions">&laquo; Typesetting Math Using HTML and CSS &mdash; Fractions</a>
          </div>
          <div class="next-post">
            <a href="/blog/2015/03/mathjax-2.4-vs-2.5" title="Next post: MathJax 2.4 vs 2.5">MathJax 2.4 vs 2.5 &raquo;</a>
          </div>
        </div>
        <div id="disqus_thread"></div>
      </div>
      <div class="sidebar">
        <h4>About</h4>
        <p>A blog about mathematics and computer programming by
          <a href="/">Jan Marthedal Rasmussen</a>.</p>
        <h4>Links</h4>
        <p><span class="icon" style="vertical-align: -8%">
          <svg viewBox="0 -1536 1408 1792">
            <g transform="matrix(1 0 0 -1 0 0)">
              <path fill="#333" d="M256 224v-192q0 -13 -9.5 -22.5t-22.5 -9.5h-192q-13 0 -22.5 9.5t-9.5 22.5v192q0 13 9.5 22.5t22.5 9.5h192q13 0 22.5 -9.5t9.5 -22.5zM256 608v-192q0 -13 -9.5 -22.5t-22.5 -9.5h-192q-13 0 -22.5 9.5t-9.5 22.5v192q0 13 9.5 22.5t22.5 9.5h192q13 0 22.5 -9.5 t9.5 -22.5zM256 992v-192q0 -13 -9.5 -22.5t-22.5 -9.5h-192q-13 0 -22.5 9.5t-9.5 22.5v192q0 13 9.5 22.5t22.5 9.5h192q13 0 22.5 -9.5t9.5 -22.5zM1792 224v-192q0 -13 -9.5 -22.5t-22.5 -9.5h-1344q-13 0 -22.5 9.5t-9.5 22.5v192q0 13 9.5 22.5t22.5 9.5h1344 q13 0 22.5 -9.5t9.5 -22.5zM256 1376v-192q0 -13 -9.5 -22.5t-22.5 -9.5h-192q-13 0 -22.5 9.5t-9.5 22.5v192q0 13 9.5 22.5t22.5 9.5h192q13 0 22.5 -9.5t9.5 -22.5zM1792 608v-192q0 -13 -9.5 -22.5t-22.5 -9.5h-1344q-13 0 -22.5 9.5t-9.5 22.5v192q0 13 9.5 22.5 t22.5 9.5h1344q13 0 22.5 -9.5t9.5 -22.5zM1792 992v-192q0 -13 -9.5 -22.5t-22.5 -9.5h-1344q-13 0 -22.5 9.5t-9.5 22.5v192q0 13 9.5 22.5t22.5 9.5h1344q13 0 22.5 -9.5t9.5 -22.5zM1792 1376v-192q0 -13 -9.5 -22.5t-22.5 -9.5h-1344q-13 0 -22.5 9.5t-9.5 22.5v192 q0 13 9.5 22.5t22.5 9.5h1344q13 0 22.5 -9.5t9.5 -22.5z"></path>
            </g>
          </svg>
        </span> <a href="/blog/">All posts</a></p>
        <p><span class="icon">
            <svg viewBox="0 0 16 16">
              <path fill="#333" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
              c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path>
            </svg>
          </span> <a href="https://twitter.com/janmarthedal">Twitter profile</a></p>
        <p><span class="icon">
            <svg viewBox="0 0 16 16">
              <path fill="#333" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path>
            </svg>
          </span> <a href="https://github.com/janmarthedal/">GitHub profile</a></p>
        <p><span class="icon" style="vertical-align: -8%">
          <svg viewBox="0 -1536 1408 1792">
            <g transform="matrix(1 0 0 -1 0 0)">
              <path fill="#333" d="M384 192q0 -80 -56 -136t-136 -56t-136 56t-56 136t56 136t136 56t136 -56t56 -136zM896 69q2 -28 -17 -48q-18 -21 -47 -21h-135q-25 0 -43 16.5t-20 41.5q-22 229 -184.5 391.5t-391.5 184.5q-25 2 -41.5 20t-16.5 43v135q0 29 21 47q17 17 43 17h5q160 -13 306 -80.5 t259 -181.5q114 -113 181.5 -259t80.5 -306zM1408 67q2 -27 -18 -47q-18 -20 -46 -20h-143q-26 0 -44.5 17.5t-19.5 42.5q-12 215 -101 408.5t-231.5 336t-336 231.5t-408.5 102q-25 1 -42.5 19.5t-17.5 43.5v143q0 28 20 46q18 18 44 18h3q262 -13 501.5 -120t425.5 -294 q187 -186 294 -425.5t120 -501.5z"></path>
            </g>
          </svg>
        </span> <a href="http://feeds.feedburner.com/janmr-blog">Subscribe in a reader</a></p>
        <footer><p class="text-muted">Copyright Jan Marthedal Rasmussen © 2017</p></footer>
      </div>
    </div>
  </div>
  <script src="/js/main.9d716cf03cf8bdc8.js" defer></script>
  <script src="https://www.google-analytics.com/analytics.js" defer></script>
</body>
</html>
